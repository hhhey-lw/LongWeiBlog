---
date: '2025-03-23T19:36:21+08:00'
draft: false
title: 'æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢'
tags: ["Projects"]
categories: ["Projects"]
description: 'Grouptradingproject'
ShowToc: true
TocOpen: true
---



# æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ

**é¡¹ç›®èƒŒæ™¯ï¼š**ä¸ºäº†ç›˜æ´»æ²‰ç¡ç”¨æˆ·ï¼Œéœ€è¦é€‚å½“é™ä½å•†å“ä»·æ ¼ã€‚ä½†ä¸ºäº†è¾¾åˆ°ä¼ æ’­çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ‹¼å›¢æ–¹å¼ï¼Œä»¥å®¢å¸¦å®¢ï¼Œé ç”¨æˆ·è‡ªèº«ä¼ æ’­çš„æ–¹å¼è¿›è¡Œäº¤æ˜“æ‹‰æ–°ã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼å¯¹æ¯”äº KOLï¼Œä¼šè®©åˆ©å•†å“ä»·å€¼åˆ°ç”¨æˆ·è‡ªèº«ã€‚



### ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡

***ä¸šåŠ¡æµç¨‹ï¼š***

![image-20250323194301660](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323194301660.png)

- *è¿è¥è§’åº¦ï¼š* 1. ç»™å“ªäº›å•†å“é…ç½®æ‹¼å•ï¼›2. æ‹¼å›¢å•†å“æä¾›çš„è§„åˆ™ä¿¡æ¯ï¼šæŠ˜æ‰£ã€æ—¶é—´ã€äººæ•°ç­‰ã€‚
- *ç”¨æˆ·è§’åº¦ï¼š* 1. å‚ä¸æ‹¼å›¢ï¼Œé¦–æ¬¡å‘èµ·orå‚ä¸ç°æœ‰ï¼Œæ‹¼å•å®Œæˆå›è°ƒé€šçŸ¥ã€‚
- *åº“è¡¨è®¾è®¡ï¼š* 1. äººç¾¤è®¾è®¡ï¼Œå°†æ‰€æœ‰ç¬¦åˆæŸä¸ªæ¡ä»¶çš„ç”¨æˆ·IDï¼Œå…¨éƒ¨å†™å…¥ç‰¹å®šRedisè®°å½•ä¸­ã€‚
- æ‹¼å›¢æ´»åŠ¨ï¼ŒæŠ˜æ‰£çš„å¤šç§è¿­ä»£ã€‚

**åº“è¡¨è®¾è®¡ï¼š**

*æ‹¼å›¢é…ç½®è¡¨*ï¼š

![image-20250323194814202](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323194814202.png)

- æ‹¼å›¢æ´»åŠ¨è¡¨ï¼šè®¾å®šäº†æ‹¼å›¢çš„æˆå›¢è§„åˆ™ï¼Œäººç¾¤æ ‡ç­¾çš„ä½¿ç”¨å¯ä»¥é™å®šå“ªäº›äººå¯è§ï¼Œå“ªäº›äººå¯å‚ä¸ã€‚
- æŠ˜æ‰£é…ç½®è¡¨ï¼šæ‹†åˆ†å‡ºæ‹¼å›¢ä¼˜æƒ åˆ°ä¸€ä¸ªæ–°çš„è¡¨è¿›è¡Œå¤šæ¡é…ç½®ã€‚å¦‚æœæŠ˜æ‰£è¿˜æœ‰æ›´å¤šçš„å¤æ‚è§„åˆ™ï¼Œåˆ™å¯ä»¥é…ç½®æ–°çš„æŠ˜æ‰£è§„åˆ™è¡¨è¿›è¡Œå¤„ç†ã€‚
- äººç¾¤æ ‡ç­¾è¡¨ï¼šä¸“é—¨æ¥åšäººç¾¤è®¾è®¡è®°å½•çš„ï¼Œè¿™3å¼ è¡¨å°±æ˜¯ä¸ºäº†æŠŠç¬¦åˆè§„åˆ™çš„äººç¾¤IDï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·IDï¼Œå…¨éƒ¨è·‘ä»»åŠ¡åˆ°ä¸€ä¸ªè®°å½•ä¸‹è¿›è¡Œä½¿ç”¨ã€‚ æ¯”å¦‚é»‘ç«ç‘°äººç¾¤ã€é«˜å‡€å€¼äººç¾¤ã€æ‹¼å›¢å±¥çº¦ç‡90%ä»¥ä¸Šçš„äººç¾¤ç­‰ã€‚



***å‚ä¸æ‹¼å›¢è¡¨ï¼š***

![image-20250323195108167](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323195108167.png)

- æ‹¼å›¢è´¦æˆ·è¡¨ï¼šè®°å½•ç”¨æˆ·çš„æ‹¼å›¢å‚ä¸æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ä¸ºäº†é™åˆ¶ç”¨æˆ·çš„å‚ä¸æ‹¼å›¢æ¬¡æ•°ï¼Œå¦å¤–æ˜¯ä¸ºäº†äººç¾¤æ ‡ç­¾ä»»åŠ¡ç»Ÿè®¡æ•°æ®ã€‚
- ç”¨æˆ·æ‹¼å•è¡¨ï¼šå½“æœ‰ç”¨æˆ·å‘èµ·é¦–æ¬¡æ‹¼å•çš„æ—¶å€™ï¼Œäº§ç”Ÿæ‹¼å•idï¼Œå¹¶è®°å½•æ‰€éœ€æˆå›¢çš„æ‹¼å•è®°å½•ï¼Œå¦å¤–æ˜¯å†™ä¸Šæ‹¼å›¢çš„çŠ¶æ€ã€å”¯ä¸€ç´¢å¼•ã€å›è°ƒæ¥å£ç­‰ã€‚è¿™æ ·æ‹¼å›¢å®Œæˆå°±å¯ä»¥å›è°ƒå¯¹æ¥çš„å¹³å°ï¼Œé€šçŸ¥å®Œæˆäº†ã€‚ã€å¾®ä¿¡æ”¯ä»˜ä¹Ÿæ˜¯è¿™æ ·çš„è®¾è®¡ï¼Œå›è°ƒæ”¯ä»˜ç»“æœï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿å¹³å°åŒ–å¯¹æ¥ã€‘å½“å†æœ‰ç”¨æˆ·å‚ä¸åï¼Œåˆ™å†™å…¥ç”¨æˆ·æ‹¼å•æ˜ç»†è¡¨ã€‚ç›´è‡³è¾¾æˆæ‹¼å›¢
- å›è°ƒä»»åŠ¡è¡¨ï¼šå½“æ‹¼å›¢å®Œæˆåï¼Œè¦åšå›è°ƒå¤„ç†ã€‚ä½†å¯èƒ½ä¼šæœ‰å¤±è´¥ï¼Œæ‰€ä»¥åŠ å…¥ä»»åŠ¡çš„æ–¹å¼è¿›è¡Œè¡¥å¿ã€‚å¦‚æœä»ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦å¯¹æ¥çš„å¹³å°ï¼Œè‡ªå·±æŸ¥è¯¢æ‹¼å›¢ç»“æœã€‚



### ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡

è¿›è¡Œç ”å‘ç³»ç»Ÿè®¾è®¡ã€‚åŒ…æ‹¬ï¼šåº“è¡¨è®¾è®¡ã€ç”¨ä¾‹å›¾ã€ç³»ç»Ÿå»ºæ¨¡ã€å·¥ç¨‹æ¨¡å‹ã€åŠŸèƒ½æµç¨‹ã€UMLæ—¶åºå›¾ã€‚

- ç”¨ä¾‹å›¾ï¼šç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼›
- æµç¨‹å›¾ï¼šåŠŸèƒ½èŠ‚ç‚¹çš„ä¸²è”å…³ç³»ï¼›
- æ—¶åºå›¾ï¼šå±•ç¤ºäº†æ•´ä¸ªæ‹¼å›¢è¿‡ç¨‹æ‰€æ¶‰åŠçš„ç³»ç»Ÿæ¨¡å—å’Œæµè½¬å…³ç³»

**ç³»ç»Ÿæ¶æ„ï¼š**

*MVCæ¶æ„*

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323200411716.png" alt="image-20250323200411716" style="zoom:50%;" />

*DDDæ¶æ„*

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323200448795.png" alt="image-20250323200448795" style="zoom:50%;" />





### ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡

***å¼•å…¥è®¾è®¡æ¨¡å¼è¿›è¡Œè§£è€¦å’Œå®ç°ï¼Œæé«˜å·¥ç¨‹ä»£ç çš„æ‰©å±•æ€§***

=> è®¾è®¡æ¨¡å¼æŠ½è±¡æ¨¡æ¿çš„é€šç”¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ ä¸€ä¸ª treeè§„åˆ™æ ‘æŠ½è±¡æ¨¡å‹ï¼Œåœ¨å¼•å…¥åˆ°å·¥ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ã€‚è¿™æ ·åç»­å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸æ–­çš„å®šä¹‰é€šç”¨çš„è®¾è®¡æ¨¡å¼è¢«ä¸åŒçš„åœºæ™¯ç»Ÿä¸€ä½¿ç”¨äº†ã€‚



**æ¨¡å‹è®¾è®¡**

é“¾å¼çš„å¤šåˆ†æ”¯è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œç”±åŠŸèƒ½èŠ‚ç‚¹è‡ªè¡Œå†³å®šåç»­æµç¨‹çš„æ‰§è¡Œé“¾è·¯ã€‚å®ƒçš„è®¾è®¡æ¯”è´£ä»»é“¾çš„æ‰©å±•æ€§æ›´å¥½ï¼Œè‡ªç”±åº¦ä¹Ÿæ›´é«˜

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323212011895.png" alt="image-20250323212011895" style="zoom:50%;" />

- é¦–å…ˆï¼Œå®šä¹‰æŠ½è±¡çš„é€šç”¨è§„åˆ™æ ‘æ¨¡å‹ç»“æ„
  - æ¶µç›–ï¼šStrategyMapper, StrategyHandler /ËˆstrÃ¦tÉ™dÊ’i/ã€AbstractStrategyRouter\<T, D, R>ã€‚ é€šè¿‡æ³›å‹è®¾è®¡å…è®¸ä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰å‡ºå…¥å‚å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡ï¼Œè®©æŠ½è±¡æ¨¡æ¿æ¨¡å‹å…·æœ‰é€šç”¨æ€§ã€‚
  - ä¹‹åï¼Œç”±ä½¿ç”¨æ–¹è‡ªå®šä¹‰å‡ºå·¥å‚ã€åŠŸèƒ½æŠ½è±¡ç±»å’Œä¸€ä¸ªä¸ªæµç¨‹æµè½¬çš„èŠ‚ç‚¹ã€‚



**ç¼–ç å®ç°**

é¡¹ç›®å·¥ç¨‹çš„Typesæ¨¡å—ä¸­ï¼Œæ·»åŠ é€šç”¨è®¾è®¡æ¨¡å¼æ¨¡æ¿

*1.1 ç­–ç•¥æ˜ å°„å™¨*

````java
public interface StrategyMapper<T, D, R> {

    /**
     * è·å–å¾…æ‰§è¡Œç­–ç•¥
     *
     * @param requestParameter å…¥å‚
     * @param dynamicContext   ä¸Šä¸‹æ–‡
     * @return è¿”å‚
     * @throws Exception å¼‚å¸¸
     */
    StrategyHandler<T, D, R> get(T requestParameter, D dynamicContext) throws Exception;

}
````

- ç”¨äºè·å–æ¯ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œè´£ä»»é“¾åŠ å¼ºç‰ˆ
- Tï¼ŒDï¼ŒRï¼šå…¥å‚ï¼Œä¸Šä¸‹æ–‡ï¼Œåå‚

*1.2 ç­–ç•¥å—ç†å™¨*

```java
public interface StrategyHandler<T, D, R> {

    StrategyHandler DEFAULT = (T, D) -> null;

    R apply(T requestParameter, D dynamicContext) throws Exception;

}
```

- æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œåˆ©ç”¨ä¸Šä¸‹æ–‡ä¼ é€’ä¿¡æ¯ç»™åé¢æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚

*1.3 ç­–ç•¥è·¯ç”±å™¨*

```java
public abstract class AbstractStrategyRouter<T, D, R> implements StrategyMapper<T, D, R>, StrategyHandler<T, D, R> {

    @Getter
    @Setter
    protected StrategyHandler<T, D, R> defaultStrategyHandler = StrategyHandler.DEFAULT;
	
    // ä¼ªä»£ç 
    public R router(T, D) throws Exception {
        StrategyHandler strategyHandler = get(T, D);
        if(null != strategyHandler) return strategyHandler.apply(T, D);
        return defaultStrategyHandler.apply(T, D);
    }

}
```

- æ‰§è¡Œå…·ä½“èŠ‚ç‚¹ï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ä¼ é€’åˆ°é»˜è®¤èŠ‚ç‚¹ä¸­



### ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½

**é¦–é¡µè¯•ç®—**

å½“ä¸€ä¸ªç”¨æˆ·è¿›å…¥åˆ°è´­ç‰©é¦–é¡µæŸ¥çœ‹å•†å“çš„ä¼˜æƒ ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºè¯•ç®—è¿‡ç¨‹ã€‚è¯•ç®—ï¼›è¯•è¯•ç®—ä¸€ä¸‹ï¼Œè¿™ä¸ªç”¨æˆ·è¿›å…¥åˆ°é¦–é¡µçœ‹è¿™ä¸ªå•†å“çš„æ—¶å€™ï¼Œå•†å“çš„è¥é”€ä¼˜æƒ ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼šåŸå§‹ä»·æ ¼ã€æŠ˜æ‰£ä»·æ ¼ã€æ‹¼å›¢ç›®æ ‡ã€æ‹¼å›¢æ—¶æ•ˆã€æ˜¯å¦å¯è§ä¼˜æƒ ã€æ˜¯å¦å¯å‚ä¸æ‹¼å›¢ç­‰ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯è¯•ç®—æ‹¿åˆ°çš„ç»“æœã€‚

**1. Modelå®šä¹‰å¯¹è±¡ï¼› 2. æœåŠ¡åŠŸèƒ½å®ç°ï¼Œtrialè¯•ç®—æ¨¡å—ï¼›3. ä¸šåŠ¡æµè½¬çš„åŠŸèƒ½èŠ‚ç‚¹**

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323214143312.png" alt="image-20250323214143312" style="zoom:50%;" />



**æ¨¡å‹é“¾è·¯**

```java
IIndexGroupBuyMarketService 
=> RootNode 
	=> multiThread[å‰ç½®å¤„ç†|æ£€æŸ¥ä¿¡æ¯] => doApply[ä¸šåŠ¡+è·¯ç”±] 
=> SwitchNode 
	=> multiThread[å‰ç½®å¤„ç†] => doApply[ä¸šåŠ¡+è·¯ç”±] 
=> MarketNode 
	=> multiThread[â­å‰ç½®å¤„ç†â­æ‹¼å•è¯•ç®—] => doApply[ä¸šåŠ¡+è·¯ç”±] 
=> EndNode 
	=> multiThread[å‰ç½®å¤„ç†] => doApply[ä¸šåŠ¡|æ„å»ºç»“æœ]     
```

**è·¯ç”±ç­–ç•¥æ¨¡æ¿[èŠ‚ç‚¹æ¨¡æ¿]**

```java
public abstract class AbstractMultiThreadStrategyRouter<T, D, R> implements StrategyMapper<T, D, R>, StrategyHandler<T, D, R> {
    
    public R router(T requestParameter, D dynamicContext) throws Exception {}
    @Override
    public R apply(T requestParameter, D dynamicContext) throws Exception {
        multiThread() // å‰ç½®å¤„ç†
        return doApply() // ä¸šåŠ¡é€»è¾‘
    }
    protected abstract void multiThread(T requestParameter, D dynamicContext) throws;
    protected abstract R doApply(T requestParameter, D dynamicContext) throws;
```

```java
public abstract class AbstractGroupBuyMarketSupport<T, D, R> extends AbstractMultiThreadStrategyRouter<T, D, R> {

    protected long timeout = 500;
    @Resource
    protected IActivityRepository repository;

    @Override
    protected void multiThread(T, D) {
        // ç©ºæ–¹æ³•ï¼Œéœ€è¦å®ç°çš„è¯ï¼Œè®©å­ç±»é‡å†™
    }

}
```

**å…·ä½“èŠ‚ç‚¹å®ä¾‹**

å·¥ä½œæµï¼šå‰ç½®å¤„ç† => ä¸šåŠ¡é€»è¾‘ => è·¯ç”±

```java
public class RootNode extends AbstractGroupBuyMarketSupport<MarketProductEntity, DynamicContext, TrialBalanceEntity> {

    @Resource
    private SwitchNode nextNode;

    @Override
    protected TrialBalanceEntity doApply(T, D, R) throws Exception {
        log.info("ä¸šåŠ¡å¤„ç†")
        return router(requestParameter, dynamicContext); // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    }

    @Override
    public StrategyHandler<T, D, R> get(T, D, R) {
        return switchNode;
    }
}
```

â­â­â­

***å¼‚æ­¥æ•°æ®åŠ è½½***

```java
// å¼‚æ­¥æŸ¥è¯¢æ´»åŠ¨é…ç½®
XXXThreadTask taskA = new XXXThreadTask(...);
FutureTask<XXX> xxxFutureTaskA = new FutureTask<>(XXXThreadTask);
threadPoolExecutor.execute(xxxFutureTask);

// å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯ -
XXXThreadTask taskB = new XXXThreadTask(...);
FutureTask<XXX> xxxFutureTaskB = new FutureTask<>(XXXThreadTask);
threadPoolExecutor.execute(xxxFutureTask);

// å†™å…¥ä¸Šä¸‹æ–‡ï¼Œ å‰ç½®æŸ¥è¯¢æ•°æ® 
dynamicContext.setXXXA(xxxFutureTaskA.get(TIMEOUT, TimeUnit.MINUTES)); // é˜»å¡æŒ‡å®šæ—¶é—´
dynamicContext.setXXXB(xxxFutureTaskB.get(TIMEOUT, TimeUnit.MINUTES));
```



---

### ç¬¬2-4èŠ‚ **ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—**

ä¸åŒä¼˜æƒ æ¨¡å¼ => ç­–ç•¥æ¨¡å¼å®ç°

**å®šä¹‰æ¥å£**

```java
public interface IDiscountCalculateService {
    BigDecimal calculate(...);
}
```

**æŠ½è±¡æ¨¡æ¿**

```java
public abstract class AbstractDiscountCalculateService implements IDiscountCalculateService {

    @Override
    public BigDecimal calculate(...) {
        // 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤
        if (IsFilter){
            boolean isCrowdRange = filterTagId(userId, groupBuyDiscount.getTagId());
            if (!isCrowdRange) return originalPrice;
        }
        // 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®—
        return doCalculate(originalPrice, groupBuyDiscount);
    }

    // äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ 
    private boolean filterTagId(String userId, String tagId) {
        // todo xiaofuge åç»­å¼€å‘è¿™éƒ¨åˆ†
        return true;
    }
	
    // å…·ä½“è®¡ç®—å‡½æ•°
    protected abstract BigDecimal doCalculate(...);

}
```

**æŠ˜æ‰£æ–¹æ³•**

```java
@Slf4j
@Service("MJ")  // æ»¡å‡ä¼˜æƒ 
public class MJCalculateService extends AbstractDiscountCalculateService {

    @Override
    public BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) {
        log.info("ä¼˜æƒ ç­–ç•¥æŠ˜æ‰£è®¡ç®—:{}", groupBuyDiscount.getDiscountType().getCode());

        // æŠ˜æ‰£è¡¨è¾¾å¼ - 100,10 æ»¡100å‡10å…ƒ
        String marketExpr = groupBuyDiscount.getMarketExpr();
        String[] split = marketExpr.split(Constants.SPLIT);
        BigDecimal x = new BigDecimal(split[0].trim());
        BigDecimal y = new BigDecimal(split[1].trim());

        // ä¸æ»¡è¶³æœ€ä½æ»¡å‡çº¦æŸï¼Œåˆ™æŒ‰ç…§åŸä»·
        if (originalPrice.compareTo(x) < 0) {
            return originalPrice;
        }

        // æŠ˜æ‰£ä»·æ ¼
        BigDecimal deductionPrice = originalPrice.subtract(y);

        // åˆ¤æ–­æŠ˜æ‰£åé‡‘é¢ï¼Œæœ€ä½æ”¯ä»˜1åˆ†é’±
        if (deductionPrice.compareTo(BigDecimal.ZERO) <= 0) {
            return new BigDecimal("0.01");
        }

        return deductionPrice;
    }

}
```

**è¥é”€è°ƒç”¨**

```java
// MarketNode

public TrialBalanceEntity doApply(T, D) throws Exception {
    log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡");

    dynamicContext.getGroupBuyActivityDiscountVO();
    groupBuyActivityDiscountVO.getGroupBuyDiscount();

    dynamicContext.getSkuVO();

    // å…·ä½“çš„ç­–ç•¥ï¼Œä¼˜æƒ æ¨¡å¼
    IDiscountCalculateService discountCalculateService = discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan());
    if (null == discountCalculateService) {
        log.info("...", JSON.toString(discountCalculateServiceMap.keys()))
    	throw ...
    }

    // æŠ˜æ‰£ä»·æ ¼
    BigDecimal deductionPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);
    dynamicContext.setDeductionPrice(deductionPrice);

    return router(requestParameter, dynamicContext);
}
```

å­¦ä¹ ç‚¹ï¼š

```java
@Service("Key")
XXX implement IDiscountCalculateService {}
    
@Resource   // â­å…ˆæŒ‰åç§°ï¼Œæ‰¾ä¸åˆ°å†æŒ‰ç±»å‹æ³¨å…¥
private Map<String, IDiscountCalculateService> discountCalculateServiceMap;
```





### ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†

ç²¾å‡†çš„å¯¹è¿™äº›ç”¨æˆ·åšå®šå‘æ´»åŠ¨æŠ•æ”¾ï¼Œæ¯”å¦‚ï¼›ç‰¹å®šçš„åˆ¸ã€ç‰¹å®šçš„é€šçŸ¥ç­‰ã€‚ä»¥æ­¤è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„è¿è¥æ•ˆæœ

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324161606013.png" alt="image-20250324161606013" style="zoom:50%;" />

äººç¾¤æ ‡ç­¾æ˜¯æ ¹æ®ç”¨æˆ·ä¸šåŠ¡è¡Œä¸ºé‡‡é›†çš„

**æ•°æ®åº“è¡¨ï¼š**

crowd_tags ï¼šç»Ÿè®¡åŠŸèƒ½ï¼›

crowd_tags_detailï¼štag_id => user_id;  å…·ä½“æ¯ä¸ªäººç¾¤éƒ½æœ‰è°ï¼›

crowd_tags_jobï¼štag_id => batch_id, tag_relu:æ¶ˆè´¹è§„åˆ™;

![image-20250324170251768](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324170251768.png)

æµç¨‹ï¼š

1. æ ¹æ®tag_id, batch_id æŸ¥è¯¢crowd_tags_jobå¾—åˆ°å¯¹åº”æ‰¹æ¬¡ä»»åŠ¡
2. é‡‡é›†ç”¨æˆ·æ•°æ®
3. æ•°æ®å†™å…¥è®°å½• // æš‚å­˜
4. æ•°æ®å†™å…¥æ•°æ®åº“  => crowd_tags_detail
5. æ›´æ–°äººç¾¤æ ‡ç­¾ç»Ÿè®¡ => crowd_tags 



**æ•°æ®å†™å…¥æ•°æ®åº“**

```java
@Override
public void addCrowdTagsUserId(String tagId, String userId) {
    CrowdTagsDetail crowdTagsDetailReq = new CrowdTagsDetail();
    crowdTagsDetailReq.setTagId(tagId);
    crowdTagsDetailReq.setUserId(userId);
    try {
        crowdTagsDetailDao.addCrowdTagsUserId(crowdTagsDetailReq);
        // è·å–BitSet
        RBitSet bitSet = redisService.getBitSet(tagId); // tagId:{userId, ...}:BitSet
        bitSet.set(redisService.getIndexFromUserId(userId), true);  // Longç±»å‹å•¥çš„è½¬æ¢ä¸€ä¸‹è·Ÿbitseté•¿åº¦ä¸€è‡´ï¼Œå°½å¯èƒ½å‡åŒ€
    } catch (DuplicateKeyException ignore) {
        // å¿½ç•¥å”¯ä¸€ç´¢å¼•å†²çª
    }
}
```

â—â—â—redisä¸­ BitSet å°±æ˜¯bitç±»å‹çš„hashtableï¼Œ è€Œ bitmapæ˜¯å­—ç¬¦ä¸²ï¼›



å¤§è‡´æ€è·¯ï¼š

```java
// æ•°æ®å†™å…¥æ•°æ®åº“æ—¶ï¼ŒåŒæ—¶æŠŠbitsetä¸­ä½ç½®ç½®1ï¼Œè¡¨ç¤ºè¿™ä¸ªç”¨æˆ·å­˜åœ¨äºè¿™ä¸ªé›†åˆ
// æŸ¥è¯¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·Idï¼ŒæŸ¥bitset                    // è¿™é‡Œç”¨æˆ·ID=>bitset:key, ä½¿ç”¨ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œä½¿å¾—æ•£åˆ—å°½å¯èƒ½å‡åŒ€
```





---

### ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†

å°†å•†å“SKUä¸æ´»åŠ¨è¡¨ è§£è€¦ => SKU&Activityå…³è”è¡¨ã€‚ä½¿å¾—å¤šä¸ªå•†å“å¯ä»¥ç»‘å®šåŒä¸€ä¸ªæ´»åŠ¨ID(ä¼˜æƒ æ‹¼å›¢æ´»åŠ¨)

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324185432351.png" alt="image-20250324185432351" style="zoom: 67%;" />

```java
# MarketèŠ‚ç‚¹ åˆ¤æ–­ å•†å“æ˜¯å¦å­˜åœ¨ä¼˜æƒ æ´»åŠ¨
=> ErrorNode => ä¸å­˜åœ¨ä¼˜æƒ æ´»åŠ¨
=> EndNode => è¿”å›ä¼˜æƒ çš„è¯•ç®—ä»·æ ¼    
```

æµç¨‹ï¼š

```java
// MarketNode => multi-thread æ£€æŸ¥æ˜¯å¦å­˜åœ¨å•†å“<=> æ´»åŠ¨å…³è”è¡¨
@Override
public GroupBuyActivityDiscountVO call() throws Exception {
    SCSkuActivityVO scSkuActivityVO = activityRepository.querySCSkuActivityBySCGoodsId(goodsId);
    // log.error(JSON.toJSONString(scSkuActivityVO));
    if (scSkuActivityVO == null) return null;
    return activityRepository.queryGroupBuyActivityDiscountVOById(scSkuActivityVO.getActivityId());
}
```

```java
// marketNode è·¯ç”±
if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) {
    return errorNode;
}
return tagNode;
```

```java
// ErrorNode åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼ŒæŠ›å‡ºæ— æ‹¼å›¢é…ç½®
log.info("æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-NoMarketNode userId:{} requestParameter:{}", requestParameter.getUserId(), JSON.toJSONString(requestParameter));

if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) {
    log.info("å•†å“æ— æ‹¼å›¢è¥é”€é…ç½® {}", requestParameter.getGoodsId());
    throw new AppException(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo());
}

return TrialBalanceEntity.builder().build();
```





---

### ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤

é™åˆ¶æ‹¼å›¢çš„äººç¾¤

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324214800601.png" alt="image-20250324214800601" style="zoom:67%;" />

æµç¨‹1ï¼š

```java
MarketNode =>  TagNode => EndNode
```

```java
// TagNode æ£€æŸ¥è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦ èƒ½çœ‹è§æ‹¼å›¢ï¼Œæ˜¯å¦å‚ä¸æ‹¼å›¢  tag_scope = {1,2} ç¬¬ä¸€ä½é™åˆ¶æ˜¯å¦å¯è§ï¼Œç¬¬äºŒä½æ˜¯å¦é™åˆ¶å‚ä¸
// redis:bitset => tag_id:{...} å­˜æ”¾æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·

// è·å–æ‹¼å›¢ä¿¡æ¯
GroupBuyActivityDiscountVO activityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO();
String tagId = activityDiscountVO.getTagId();
boolean visible = activityDiscountVO.isVisible();
boolean enable = activityDiscountVO.isEnable();

// æ— ç‰¹å®šäººç¾¤ä¿¡æ¯, äººäººèƒ½æ“ä½œ
if (StringUtils.isBlank(tagId)) {
    dynamicContext.setVisible(true);
    dynamicContext.setEnable(true);
    return router(requestParameter, dynamicContext);
}

// æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œç‰¹å®šäººç¾¤èƒ½çœ‹
boolean isWithin = repository.isTagCrowdRange(tagId, requestParameter.getUserId());
dynamicContext.setVisible(visible || isWithin);
dynamicContext.setEnable(enable || isWithin);

return router(requestParameter, dynamicContext);


// => isTagCrowdRange function
// xiaofugeã€liergouåœ¨é‡Œé¢
RBitSet bitSet = redisService.getBitSet(tagId);
if (!bitSet.isExists()) return true;
// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨äººç¾¤ä¸­
return bitSet.get(redisService.getIndexFromUserId(userId));    
```



---

### ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ

ç›®çš„ï¼šå¦‚ä½•ä¸åœè½¦å°±ç»™æ±½è½¦æ¢ä¸ªè½®å­ï¼Ÿ

=> åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç›´æ¥åŠ¨æ€å˜æ›´æŸäº›å±æ€§é…ç½®ã€‚è¿™äº›åŠ¨æ€å˜æ›´çš„é…ç½®åŒ…æ‹¬é™çº§å’Œåˆ‡é‡çš„å¼€å…³ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›åŠŸèƒ½ç¨‹åºçš„ç™½åå•ç”¨æˆ·æµ‹è¯•ã€‚

**ä½¿ç”¨Redisä½œä¸ºé›†ä¸­åŒ–å‚¨å­˜ç³»ç»Ÿçš„å¥½å¤„ï¼Œæ–¹ä¾¿ä¸€å¤„ä¿®æ”¹å˜é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„å®ä¾‹è¿›è¡Œå˜æ›´ï¼**

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324220542463.png" alt="image-20250324220542463" style="zoom:50%;" />



**æµé‡é™çº§æˆ–åˆ‡é‡**

```java
// è‡ªå®šä¹‰æ³¨è§£
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
@Documented
public @interface DCCValue {
    String value() default "";
}

// åŠ¨æ€ä¸­å¿ƒæ§åˆ¶ -- ä½œç”¨äºé™çº§
@Service
public class DCCService {

    /**
     * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯
     */
    @DCCValue("downgradeSwitch:0")
    private String downgradeSwitch;

    @DCCValue("cutRange:100")
    private String cutRange;

    public boolean isCutRange(String userId) {
        // è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼
        int hashCode = Math.abs(userId.hashCode());

        // è·å–æœ€åä¸¤ä½
        int lastTwoDigits = hashCode % 100;

        // åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†…
        if (lastTwoDigits <= Integer.parseInt(cutRange)) {
            log.error(cutRange);
            return true;
        }

        return false;
    }

    public boolean isDowngradeSwitch() {
        return this.downgradeSwitch.equals("1");
    }
}

// SwitchNodeä¸­ è¿›è¡Œæµé‡æ§åˆ¶
// æ ¹æ®ç”¨æˆ·IDåˆ‡é‡
String userId = requestParameter.getUserId();

// åˆ¤æ–­æ˜¯å¦é™çº§
if (activityRepository.downgradeSwitch()) {
    log.info("æ‹¼å›¢æ´»åŠ¨é™çº§æ‹¦æˆª {}", userId);
    throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo());
}

// åˆ¤æ–­æ˜¯å¦åˆ‡é‡
if (activityRepository.cutRange(userId)) {
    log.info("æ‹¼å›¢æ´»åŠ¨åˆ‡é‡æ‹¦æˆª {}", userId);
    throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo());
}
```

**åˆ©ç”¨Redisçš„Topicäº‹ä»¶å‘å¸ƒè®¢é˜… è¿›è¡Œ ä¿®æ”¹**

BeanPostProcessor èƒ½å¤Ÿå½“SpringBeanåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œ

```java
// DCCValueBeanFactory implements BeanPostProcessor 
private static final String BASE_CONFIG_PATH = "group_buy_market_dcc_";

private final RedissonClient redissonClient;

private final Map<String, Object> dccObjGroup = new HashMap<>();

public DCCValueBeanFactory(RedissonClient redissonClient) {
    this.redissonClient = redissonClient;
}

@Bean("dccTopic")
public RTopic dccRedisTopicListener(RedissonClient redissonClient) {
    log.info("åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}", redissonClient.getBucket("test").get());
    // å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç°
    RTopic topic = redissonClient.getTopic("group_buy_market_dcc");
    // æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯
    topic.addListener(String.class, ((charSequence, s) -> {
        log.info("ç›‘å¬åˆ°Redis Topicï¼š {}", charSequence.toString());
        String[] split = s.split(Constants.SPLIT);

        // è·å–å€¼
        String attribute = split[0];
        String key = BASE_CONFIG_PATH + attribute;
        String value = split[1];

        // è®¾ç½®å€¼ => å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
        RBucket<String> bucket = redissonClient.getBucket(key);
        boolean exists = bucket.isExists();
        if (!exists) return;
        bucket.set(value);

        Object objBean = dccObjGroup.get(key); // è·å–å†…å­˜ä¸­çš„å¯¹è±¡
        if (objBean == null) return;

        Class<?> objBeanClass = objBean.getClass();
        // æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡
        if (AopUtils.isAopProxy(objBean)) {
            objBeanClass = AopUtils.getTargetClass(objBean);
        }

        try {
            Field field = objBeanClass.getDeclaredField(attribute);
            field.setAccessible(true);
            field.set(objBean, value);
            field.setAccessible(false);

            log.info("DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}", key,value);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }

    }));
    return topic;
}


// implements BeanPostProcessor é‡å†™æ–¹æ³•  -- å¹¶åœ¨æ¯ä¸ª bean åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ã€‚
@Override
public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
    // æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº†
    Class<?> targetBeanClass = bean.getClass();
    Object targetBeanObject = bean;
    if (AopUtils.isAopProxy(targetBeanObject)) {
        targetBeanClass = AopUtils.getTargetClass(targetBeanObject);
        targetBeanObject = AopProxyUtils.getSingletonTarget(bean);
    }
	
    // è¿™é‡Œåˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰å¯¹åº”çš„è‡ªå®šä¹‰æ³¨è§£
    Field[] fields = targetBeanClass.getDeclaredFields();
    for (Field field : fields) {
        if (!field.isAnnotationPresent(DCCValue.class)) {
            continue;
        }

        DCCValue dccValue = field.getAnnotation(DCCValue.class);
        String value = dccValue.value();
        if (StringUtils.isBlank(value)) {
            throw new RuntimeException(field.getName() + "@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€");
        }

        String[] split = value.split(":");
        String key = BASE_CONFIG_PATH.concat(split[0]);
        String defaultValue = split[1];

        String setValue = defaultValue;

        try {
            if (StringUtils.isBlank(defaultValue)) {
                throw new RuntimeException("dcc config error " + key + " is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼");
            }

            RBucket<String> bucket = redissonClient.getBucket(key);
            boolean exists = bucket.isExists();
            if (!exists) {
                bucket.set(defaultValue);
            } else {
                setValue = bucket.get();
            }

            field.setAccessible(true);
            field.set(targetBeanObject, setValue);
            field.setAccessible(false);
            log.info("åˆå§‹åŒ–å€¼ key:{} value:{}", key, setValue);
        } catch (IllegalAccessException e) {
            throw new RuntimeException(e);
        }

        dccObjGroup.put(key, targetBeanObject);
    }
    return bean;
}
```

**Controller**

```java
@Override
@GetMapping("update_config")
public Response<Boolean> updateConfig(@RequestParam String key, @RequestParam String value) {
    try {
        log.info("DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}", key, value);
        dccTopic.publish(key + "," + value);
        return Response.<Boolean>builder()
            .code(ResponseCode.SUCCESS.getCode())
            .info(ResponseCode.SUCCESS.getInfo())
            .build();
    } catch (Exception e) {
        log.error("DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}", key, value, e.getMessage());
        return Response.<Boolean>builder()
            .code(ResponseCode.UN_ERROR.getCode())
            .info(ResponseCode.UN_ERROR.getInfo())
            .build();
    }
}
```

â±ï¸25/3/24-23:34



### ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•

25/3/25/ 20:37

å®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250325203753717.png" alt="image-20250325203753717" style="zoom: 80%;" />

- é¦–å…ˆï¼Œå›¢è´­å•†å“ä¸‹å•ã€‚ä¸‹å•è¿‡ç¨‹åˆ†ä¸ºï¼šåˆ›å»ºæµæ°´å•ã€é”å®šè¥é”€ä¼˜æƒ ï¼ˆæ‹¼å›¢ã€ç§¯åˆ†ã€å·ï¼‰ï¼Œåˆ›å»ºæ”¯ä»˜è®¢å•ã€å”¤èµ·æ”¶é“¶å°æ”¯ä»˜ã€ç”¨æˆ·æ‰«ç æ”¯ä»˜ã€æ”¯ä»˜å®Œæˆæ ¸é”€ä¼˜æƒ ç­‰ã€‚
- ç”¨æˆ·ä»¥æ‹¼å›¢çš„æ–¹å¼ä¸‹å•ï¼Œåˆ›å»ºæµæ°´å•å®Œæˆåï¼Œéœ€è¦ä¸æ‹¼å›¢ç³»ç»Ÿäº¤äº’ï¼Œé”å®šè¥é”€ä¼˜æƒ ã€‚æ›´æ–°æµæ°´å•ä¼˜æƒ é‡‘é¢å’Œæ”¯ä»˜é‡‘é¢ã€‚åˆ›å»ºè®¢å•ä½¿ç”¨æœ€ç»ˆçš„æ”¯ä»˜é‡‘é¢ã€‚
- æ‹¼å›¢è¡¨(ç›®æ ‡é‡ã€å®Œæˆé‡ã€é”å•é‡)ï¼Œé”å•é‡è¾¾åˆ°ç›®æ ‡é‡åï¼Œä¸èƒ½å†å‚ä¸è¯¥æ‹¼å›¢ã€‚æ‹¼å›¢è¶…æ—¶ï¼Œé‡Šæ”¾ç©ºé—²ä½ç½®è®©å…¶ä»–ç”¨æˆ·å‚ä¸.

*Trade Repository  / rÉªËˆpÉ’zÉ™t(É™)ri /*

```java
// ç®€å•å®ç°æ­¥éª¤
// OutTradeNO æ¨¡æ‹Ÿç”Ÿæˆ è®¢å•IDæ¨¡æ‹Ÿç”Ÿæˆ, TeamIDæ¨¡æ‹Ÿç”Ÿæˆ. ä¸¤å¼ è¡¨:1.è®°å½•æ‹¼å›¢ä¸­æ¯ä¸ªç”¨æˆ·çš„ä¿¡æ¯ 2. è®°å½•è¯¥æ‹¼å›¢ä¿¡æ¯.

// â­ä»“å‚¨ä¸šåŠ¡å®ç°
// åˆ¤æ–­æ˜¯å¦æœ‰å›¢  -- ä¸€è¡Œè®°å½•å­˜å‚¨æ¯ä¸ªæ‹¼å›¢çš„ä¿¡æ¯
// é¦–æ¬¡åˆ™åˆ›å»ºæ‹¼å›¢è®¢å•. åˆå§‹åŒ–è¡¨2
// å¦åˆ™åŠ å…¥å…¶ä»–äººçš„å›¢ è¡¨2 æ‹¼å›¢äººæ•°+1

// æ’å…¥è¯¥ç”¨æˆ·çš„æ‹¼å›¢ä¿¡æ¯åˆ°è¡¨1; æ¯ä¸ªç”¨æˆ·ä¸€è¡Œ

// â­æ§åˆ¶å™¨ä¸šåŠ¡å®ç°
// 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
// 2. æŸ¥è¯¢ç”¨æˆ·outTradeNoæ˜¯å¦å·²ç»ä½¿ç”¨è¿‡,å¹‚ç­‰æ€§
// 3. æŸ¥è¯¢æ‹¼å›¢æ˜¯å¦äººæ•°å·²æ»¡è¶³
// 4. è¥é”€ä¼˜æƒ è¯•ç®—
// 5. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½å¤Ÿçœ‹è§æ‹¼å›¢å’Œå‚ä¸
// 6. æ‹¼å›¢é”å• => ä»“å‚¨ä¸šåŠ¡
// 7. è¿”å›ç»“æœ
```



### ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡

25/4/8/ 15:53

å…ˆå‰çš„è´£ä»»é“¾æ¨¡æ¿éƒ½æ˜¯å†™æ­»çš„ã€‚æœ¬ç« å†…å®¹ä¸ºï¼šå°†æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘å’Œé“¾æ¥é€»è¾‘è§£è€¦ã€‚

æŠ½è±¡

![image-20250408155522466](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250408155522466.png)

ç®€å•çš„å•ä¾‹é“¾

```java
// 1. IlogicChainArmory:   è£…é…é“¾ï¼Œæä¾›æ·»åŠ èŠ‚ç‚¹æ–¹æ³•å’Œè·å–èŠ‚ç‚¹
// 		next()
//		appendNext()
// 2. ILogicLink extends IlogicChainArmory:  å¹¶æä¾›ä¸€ä¸ªå—ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•
//		apply()
// 3. AbstractLogicLink extends ILogicLink:  å°è£…æ·»åŠ èŠ‚ç‚¹å’Œæ‰§è¡Œ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•
//      next()
//		appendNext()
// 		apply()
```

è¿™é‡Œæ˜¯ç”±ç»Ÿä¸€çš„**ç±»**ç»´æŠ¤è´£ä»»é“¾ï¼Œä¹Ÿå°±æ˜¯ä¸€ä»½è´£ä»»é“¾ã€‚å¦‚æœæœ‰2ä¸ªç‹¬ç«‹çš„é“¾è¦å¤„ç†ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°éå•ä¾‹çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦åˆ™ä¼šä¿®æ”¹åŒä¸€ä»½é“¾ã€‚ä¹Ÿå°±æ˜¯ `ILogicLink<T, D, R> next `è¢«å‡ ä»½é“¾åå¤è°ƒæ•´ï¼Œä¹Ÿå°±ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„é“¾äº†ã€‚



å¤šä¾‹-é“¾è·¯æ¨¡å¼

å¤šä¾‹é“¾çš„è®¾è®¡è¦è§£è€¦é“¾è·¯å’Œæ‰§è¡Œï¼ŒæŠŠé“¾è·¯å½“åšä¸€ä¸ª LinkedList åˆ—è¡¨å¤„ç†ï¼Œä¹‹åæ‰§è¡Œå½“åšæ˜¯å•ç‹¬çš„ for å¾ªç¯ã€‚

```java
// éœ€è¦è®¾è®¡çš„ç±»
// 1. Node & LinkedList extends ILink
// åŒå‘é“¾è¡¨èŠ‚ç‚¹ & åŒå‘é“¾è¡¨

// 2. BusinessLinkedList extends LinkedList
// ä»å¤´åˆ°å°¾æ‰§è¡Œå„ä¸ªèŠ‚ç‚¹

// 3. ILogicHandler  -- å®šä¹‰ä»»åŠ¡

// 4. LinkArmory -- åˆ›å»ºé“¾è¡¨å¹¶è£…é…èŠ‚ç‚¹
// public LinkArmory(String linkName, ILogicHandler<T, D, R>... logicHandlers)
// private final BusinessLinkedList<T, D, R> logicLink;
```

```java
// ç”¨æ³•
// 1. å®šä¹‰ RuleLogicNode extends ILogicHandler
// 2. new LinkArmory<>("demo01", ruleLogic201, ruleLogic202, ...);
```

å…·ä½“ä¼ªä»£ç 

```java
public class LinkedList<E> implements ILink<E> {

    /**
     * è´£ä»»é“¾åç§°
     * */
    @Getter
    private final String name;
    transient int size = 0;
    transient Node<E> first;
    transient Node<E> last;

    public LinkedList(String name) {
        this.name = name;
    }

    // å¤´æ’èŠ‚ç‚¹
    void linkFirst(E e) {
        final Node<E> f = first;
        final Node<E> newNode = new Node<>(null, e, f);
        first = newNode;
        if (f == null)
            last = newNode;
        else
            f.prev = newNode;
        size++;
    }

    // å°¾æ’æ³•
    void linkLast(E e) {
        final Node<E> l = last;
        final Node<E> newNode = new Node<>(l, e, null);
        last = newNode;
        if (l == null) {
            first = newNode;
        } else {
            l.next = newNode;
        }
        size++;
    }

    @Override
    public boolean add(E e) {
        linkLast(e);
        return true;
    }

    @Override
    public boolean addFirst(E e) {
        linkFirst(e);
        return true;
    }

    @Override
    public boolean addLast(E e) {
        linkLast(e);
        return true;
    }

    @Override
    public boolean remove(Object o) {
        if (o == null) {
            for (Node<E> x=first; x!=null; x=x.next) {
                if (x.item == null) {
                    unlink(x);
                    return true;
                }
            }
        } else {
            for (Node<E> x=first; x!=null; x=x.next) {
                if (o.equals(x.item)) {
                    unlink(x);
                    return true;
                }
            }
        }
        return false;
    }
	
    // åˆ é™¤èŠ‚ç‚¹ï¼Œæ³¨æ„æ˜¯åŒå‘é“¾è¡¨
    E unlink(Node<E> x) {
        final E element = x.item;
        final Node<E> next = x.next;
        final Node<E> prev = x.prev;

        // xä¸ºå¤´èŠ‚ç‚¹
        if (prev == null) {
            first = next;
        } else {
            prev.next = next;
            x.prev = null;
        }

        // xä¸ºæœ«å°¾
        if (next == null) {
            last = x.prev;
        } else {
            next.prev = prev;
            x.next = null;
        }

        x.item = null;
        size--;
        return element;
    }

    @Override
    public E get(int index) {
        return node(index).item;
    }	
	
    // æ ¹æ®indexï¼Œåˆ¤æ–­æ˜¯å‰å‘è¿˜æ˜¯åå‘
    private Node<E> node(int index) {
        if (index < (size >> 1)) {
            Node<E> x = first;
            for (int i = 0; i < index; i++) {
                x = x.next;
            }
            return x;
        } else {
            Node<E> x = last;
            for (int i = size-1; i > index; i--) {
                x = x.prev;
            }
            return x;
        }
    }

    @Override
    public void printLinkList() {
        if (this.size == 0) {
            System.out.printf("é“¾è¡¨ä¸ºç©º");
        } else {
            Node<E> temp = first;
            System.out.print("ç›®å‰çš„åˆ—è¡¨ï¼Œå¤´èŠ‚ç‚¹ï¼š" + first.item + " å°¾èŠ‚ç‚¹ï¼š" + last.item + " æ•´ä½“ï¼š");
            while (temp != null) {
                System.out.print(temp.item + "ï¼Œ");
                temp = temp.next;
            }
            System.out.println();
        }
    }
}
```



### ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤

2025-4-8 17:30

![image-20250408175143439](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250408175143439.png)

è¯¥ç« èŠ‚è¡¥å……ï¼šè¿‡æ»¤æ‹¼å›¢æ´»åŠ¨é…ç½®çš„è§„åˆ™ã€‚åŒ…æ‹¬ï¼›æ´»åŠ¨çš„æœ‰æ•ˆæœŸã€çŠ¶æ€ï¼Œä»¥åŠä¸ªäººå‚ä¸æ‹¼å›¢çš„æ¬¡æ•°ã€‚

```java
// Logic chain
// 1. æ£€æŸ¥å‚æ•°
// 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œæ ¹æ®å¤–éƒ¨OrderId
// 3. åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨æ˜¯å¦æ»¡
// 4. è¥é”€è¯•ç®— -- ç»™å‡ºæŠ˜æ‰£ä»·æ ¼
// 5. äººç¾¤é™å®š -- ç‰¹å®šäººç¾¤æ‰èƒ½æ‹¼å›¢
// 6. æ‹¼å›¢é”å• -- 1. ä¿®æ”¹æ´»åŠ¨è¡¨å¯¹åº”çš„ä¿¡æ¯ 2. æ’å…¥ä¸€æ¡æ‹¼å›¢è®°å½•
// 6.1. äº¤æ˜“è§„åˆ™è¿‡æ»¤  -- æ£€æŸ¥æ´»åŠ¨æ—¶é—´ + æ£€æŸ¥æ‹¼å›¢æ¬¡æ•°  â­æœ¬èŠ‚ä¸»è¦è¿™éƒ¨åˆ†
```

å…·ä½“å°±æ˜¯å®šä¹‰ä¸€äº› è´£ä»»é“¾èŠ‚ç‚¹(æ‹¦æˆªå™¨)

```java
@Slf4j
@Service
public class ActivityUsabilityRuleFilter implements ILogicHandler<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("äº¤æ˜“è§„åˆ™è¿‡æ»¤-æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒ{} activityId:{}", requestParameter.getUserId(), requestParameter.getActivityId());

        // æŸ¥è¯¢æ‹¼å›¢æ´»åŠ¨
        GroupBuyActivityEntity groupBuyActivityEntity = repository.queryGroupBuyActivityEntityByActivityId(requestParameter.getActivityId());

        // æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€
        if (!ActivityStatusEnumVO.EFFECTIVE.equals(groupBuyActivityEntity.getStatus())) {
            log.info("æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéç”Ÿæ•ˆçŠ¶æ€ activityId:{}", requestParameter.getActivityId());
            throw new AppException(ResponseCode.E0101);
        }

        // æ ¡éªŒï¼›æ´»åŠ¨æ—¶é—´
        Date now = new Date();
        if (now.before(groupBuyActivityEntity.getStartTime()) || now.after(groupBuyActivityEntity.getEndTime())) {
            log.info("æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéå¯å‚ä¸æ—¶é—´èŒƒå›´ activityId:{}", requestParameter.getActivityId());
            throw new AppException(ResponseCode.E0102);
        }

        dynamicContext.setGroupBuyActivity(groupBuyActivityEntity);

        // èµ°åˆ°ä¸‹ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹
        return next(requestParameter, dynamicContext);
    }
}
```

```java
@Slf4j
@Service
public class UserTakeLimitRuleFilter implements ILogicHandler<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("äº¤æ˜“è§„åˆ™è¿‡æ»¤-ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒ{} activityId{}", requestParameter.getUserId(), requestParameter.getActivityId());

        GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity();

        Integer count = repository.queryOrderCountByActivityId(requestParameter.getActivityId(), requestParameter.getUserId());

        if (groupBuyActivity.getTakeLimitCount() != null && count >= groupBuyActivity.getTakeLimitCount()) {
            log.info("ç”¨æˆ·å‚æ•°æ¬¡æ•°æ ¡éªŒï¼Œå·²è¾¾å¯å‚ä¸ä¸Šé™ activityId:{}", requestParameter.getActivityId());
            throw new AppException(ResponseCode.E0103);
        }

        return TradeRuleFilterBackEntity.builder()
                .userTakeOrderCount(count)
                .build();
    }
}
```

ç»„è£…è´£ä»»é“¾  -- BusinessLinkedList å…·ä½“ä¸šåŠ¡

```java
@Bean("tradeRuleFilter")
public BusinessLinkedList<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity>
    tradeRuleFilter(ActivityUsabilityRuleFilter activityUsabilityRuleFilter, UserTakeLimitRuleFilter userTakeLimitRuleFilter) {
    // ç»„è£…é“¾
    LinkArmory<TradeRuleCommandEntity, DynamicContext, TradeRuleFilterBackEntity> filter = new LinkArmory<>("äº¤æ˜“è§„åˆ™è¿‡æ»¤é“¾", activityUsabilityRuleFilter, userTakeLimitRuleFilter);
    // é“¾å¯¹è±¡
    return filter.getLogicLink();
}
```

LinkArmory  -- çœŸæ­£çš„æŠ½è±¡è£…é…è´£ä»»é“¾

```java
@SafeVarargs
public LinkArmory(String linkName, ILogicHandler<T, D, R>... logicHandlers) {
    logicLink = new BusinessLinkedList<>(linkName);
    for (ILogicHandler<T, D, R> logicHandler: logicHandlers){
        logicLink.add(logicHandler);
    }
}
public BusinessLinkedList<T, D, R> getLogicLink() {
    return logicLink;
}
```



ç”¨æ³•

```java
@Resource
private BusinessLinkedList<TradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity> tradeRuleFilter;

tradeRuleFilter.aaply(...)
```



---

### ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡

25/4/8 21:19

 ![image-20250408224034286](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250408224034286.png)

æ‹¼å›¢çš„è¿‡ç¨‹æ˜¯ç”¨æˆ·åœ¨å•†åŸä¸‹å•ï¼Œé”å®šæ‹¼å›¢ä¼˜æƒ ï¼ˆä¹Ÿå°±æ˜¯æ‹¼å›¢ç³»ç»Ÿé‡Œé”å•çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åå°±æ˜¯ç”¨æˆ·ç»™è¿™ç¬”å•†å“å®Œæˆæ”¯ä»˜äº¤æ˜“ï¼Œäº¤æ˜“åä¸ä¼šç›´æ¥å‘è´§ï¼Œç›´è‡³æ‹¼å›¢ç»„é˜Ÿå®Œæˆåæ‰ä¼šå‘è´§ã€‚

é‚£ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯æ”¯ä»˜å®Œæˆåï¼Œéœ€è¦åšæ‹¼å›¢æ•°é‡çš„ç»Ÿè®¡ç»“ç®—ã€‚å¦‚ï¼Œæ‹¼å›¢éœ€è¦3ä¸ªç”¨æˆ·ä¸€èµ·ä¸‹å•ï¼Œé‚£ä¹ˆæ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±è¦ç»™æ‹¼å›¢çš„ç»„é˜ŸåŠ ä¸Šä¸€ç¬”è®°å½•ã€‚è¿™ä¸ªå°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„æµç¨‹ã€‚

â­â­â­ æ‰€æœ‰ç”¨æˆ·å®Œæˆæ”¯ä»˜å, æœ€åä¸€ä¸ªç”¨æˆ·çš„ç»“ç®—è§¦å‘å›è°ƒäº‹ä»¶!

```java
@Transactional(timeout = 500)
@Override
public void settlementMarketPayOrder(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate) {
    UserEntity userEntity = groupBuyTeamSettlementAggregate.getUserEntity();
    GroupBuyTeamEntity groupBuyTeamEntity = groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity();
    TradePaySuccessEntity tradePaySuccessEntity = groupBuyTeamSettlementAggregate.getTradePaySuccessEntity();

    // 1. æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€
    GroupBuyOrderList groupBuyOrderList = new GroupBuyOrderList();
    groupBuyOrderList.setUserId(userEntity.getUserId());
    groupBuyOrderList.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo());
    int updateOrderStatus2COMPLETE = groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderList);
    if (1 != updateOrderStatus2COMPLETE) {
        throw new AppException(ResponseCode.UPDATE_ZERO);
    }
	
    // 2. æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡
    int updateAddCount = groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId());
    if (1 != updateAddCount) {
        throw new AppException(ResponseCode.UPDATE_ZERO);
    }

    // 3. æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€
    if (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == 1) {
        int i = groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId());
        if (1 != i) {
            throw new AppException(ResponseCode.UPDATE_ZERO);
        }

        // æŸ¥è¯¢æ‹¼å›¢äº¤æ˜“å¤–éƒ¨è®¢å•å·åˆ—è¡¨
        List<String> outOrderNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId());

        // æ‹¼å›¢å®Œæˆå†™å…¥å›è°ƒä»»åŠ¡è®°å½•
        NotifyTask notifyTask = NotifyTask.builder()
            .activityId(groupBuyTeamEntity.getActivityId())
            .teamId(groupBuyTeamEntity.getTeamId())
            .notifyUrl("æš‚æ— ")
            .notifyCount(0)
            .notifyStatus(0)
            .build();
        notifyTask.setParameterJson(JSON.toJSONString(new HashMap<String, Object>() {{
            put("teamId", groupBuyTeamEntity.getTeamId());
            put("outTradeNoList", outOrderNoList);
        }}));

        notifyTaskDao.insert(notifyTask);
    }

}
```

è¿™é‡Œç®—æ˜¯æ”¯ä»˜æˆåŠŸåçš„å›è°ƒ



---

### **ç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤**

â±ï¸25/4/9 12:31

![image-20250409152543493](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250409152543493.png)

æœ¬èŠ‚è¯‰æ±‚ï¼š

æ‹¼å›¢äº¤æ˜“ç»“ç®—çš„è¿‡ç¨‹ï¼Œéœ€è¦ä¸€äº›åˆ—çš„è§„åˆ™è¿‡æ»¤ã€‚åŒ…æ‹¬ï¼›æˆ‘ä»¬ä¸Šä¸€èŠ‚æåˆ°çš„æ ¡éªŒå¤–éƒ¨äº¤æ˜“å•çš„æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…ï¼ŒåŒæ—¶è¿˜æœ‰å…³äºè¿™ç¬”å¤–éƒ¨äº¤æ˜“å•æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ‹¼å›¢é”å•è®¢å•ã€‚å¦å¤–åƒæ˜¯ SC æ¸ é“çš„æœ‰æ•ˆæ€§ä¹Ÿéœ€è¦åœ¨ç»“ç®—æ—¶è¿›è¡Œæ ¡éªŒã€‚

æ‰€ä»¥ï¼Œæœ¬èŠ‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€å¥—è§„åˆ™é“¾ï¼Œæ¥å¤„ç†è¿™äº›ä¸šåŠ¡è§„åˆ™ã€‚å› ä¸ºè§„åˆ™é“¾å·²ç»è¢«æŠ½å–ä¸ºé€šç”¨çš„æ¨¡æ¿äº†ï¼Œé‚£ä¹ˆæœ¬èŠ‚ä½¿ç”¨èµ·æ¥ä¼šéå¸¸å®¹æ˜“ã€‚



è´£ä»»é“¾æµç¨‹ï¼š1. æ ¡éªŒæ¸ é“æ˜¯å¦ä¸ºé»‘åå• 2. å¤–éƒ¨è®¢å•å·æ˜¯å¦æ­£ç¡® 3. äº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæœŸå†… 4. æ‰“åŒ…ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡

***è´£ä»»é“¾åŒ…è£…å¯¹è±¡***

```java
@Bean("tradeSettlementRuleFilter")
public BusinessLinkedList<TradeSettlementRuleCommandEntity,
TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> tradeSettlementRuleFilter(
    SCRuleFilter scRuleFilter, OutTradeNoRuleFilter outTradeNoRuleFilter, SettableRuleFilter settableRuleFilter, EndRuleFilter endRuleFilter
) {
    LinkArmory<TradeSettlementRuleCommandEntity, DynamicContext, TradeSettlementRuleFilterBackEntity> tradeSettlementFilter =
        new LinkArmory<>("äº¤æ˜“ç»“ç®—è§„åˆ™è¿‡æ»¤é“¾", scRuleFilter, outTradeNoRuleFilter, settableRuleFilter, endRuleFilter);

    return tradeSettlementFilter.getLogicLink();

}
```

1 SCè¿‡æ»¤å™¨

```java
@Slf4j
@Service
public class SCRuleFilter  implements ILogicHandler<TradeSettlementRuleCommandEntity,
        TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        // 1. æ‰“å°å‡½æ•°æµç¨‹ä¿¡æ¯
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-æ¸ é“é»‘åå•æ ¡éªŒ{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        // 2. æ ¡éªŒé»‘åå•ä¿¡æ¯
        Boolean intercept = repository.isSCBlackIntercept(requestParameter.getSource(), requestParameter.getChannel());
        if (intercept) {
            log.info("{}-{} æ¸ é“é»‘åå•æ‹¦æˆª", requestParameter.getSource(), requestParameter.getChannel());
            throw new AppException(ResponseCode.E0105);
        }

        return next(requestParameter, dynamicContext);
    }
}
```

2 è®¢å•å·æ ¡éªŒè¿‡æ»¤å™¨

```java
@Slf4j
@Service
public class OutTradeNoRuleFilter  implements ILogicHandler<TradeSettlementRuleCommandEntity,
        TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-å¤–éƒ¨å•å·æ ¡éªŒ{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        MarketPayOrderEntity marketPayOrderEntity = repository.queryMarketPayOrderEntityByOutTradeNo(requestParameter.getUserId(), requestParameter.getOutTradeNo());

        if (null == marketPayOrderEntity) {
            log.info("ä¸å­˜åœ¨çš„å¤–éƒ¨äº¤æ˜“å•å·æˆ–ç”¨æˆ·å·²é€€å•ï¼Œä¸éœ€è¦åšæ”¯ä»˜è®¢å•ç»“ç®—ï¼š{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());
            throw new AppException(ResponseCode.E0104);
        }

        dynamicContext.setMarketPayOrderEntity(marketPayOrderEntity);

        return next(requestParameter, dynamicContext);
    }
}
```

3 æœ‰æ•ˆæœŸæ ¡éªŒå™¨

```java
@Slf4j
@Service
public class SettableRuleFilter  implements ILogicHandler<TradeSettlementRuleCommandEntity,
        TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {

    @Resource
    private ITradeRepository repository;

    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-æœ‰æ•ˆæ—¶é—´æ ¡éªŒï¼š{}, {}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        // 1. ä¸Šä¸‹æ–‡è·å–æ•°æ®
        MarketPayOrderEntity marketPayOrderEntity = dynamicContext.getMarketPayOrderEntity();

        // 2. æŸ¥è¯¢æ‹¼å›¢å¯¹è±¡
        GroupBuyTeamEntity groupBuyTeamEntity = repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId());

        // 3. å¤–éƒ¨äº¤æ˜“æ—¶é—´ - æ”¯ä»˜æ—¶é—´éœ€è¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…å®Œæˆ
        if (requestParameter.getOutTradeTime().after(groupBuyTeamEntity.getValidEndTime())){
            // 4. åˆ¤æ–­ï¼Œå¤–éƒ¨äº¤æ˜“æ—¶é—´æ˜¯å¦å°äºæ‹¼å›¢ç»“æŸæ—¶é—´
            log.info("è®¢å•äº¤æ˜“æ—¶é—´ä¸åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…");
            throw new AppException(ResponseCode.E0106);
        }

        // 5. è®¾ç½®ä¸Šä¸‹æ–‡
        dynamicContext.setGroupBuyTeamEntity(groupBuyTeamEntity);

        return next(requestParameter, dynamicContext);
    }
}
```

4 æ‰“åŒ…èŠ‚ç‚¹

```java
@Slf4j
@Service
public class EndRuleFilter implements ILogicHandler<TradeSettlementRuleCommandEntity,
        TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity> {
    @Override
    public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception {
        log.info("ç»“ç®—è§„åˆ™è¿‡æ»¤-ç»“æŸèŠ‚ç‚¹{} outTradeNo:{}", requestParameter.getUserId(), requestParameter.getOutTradeNo());

        GroupBuyTeamEntity groupBuyTeamEntity = dynamicContext.getGroupBuyTeamEntity();

        return TradeSettlementRuleFilterBackEntity.builder()
                .teamId(groupBuyTeamEntity.getTeamId())
                .activityId(groupBuyTeamEntity.getActivityId())
                .completeCount(groupBuyTeamEntity.getCompleteCount())
                .targetCount(groupBuyTeamEntity.getTargetCount())
                .validStartTime(groupBuyTeamEntity.getValidStartTime())
                .validEndTime(groupBuyTeamEntity.getValidEndTime())
                .lockCount(groupBuyTeamEntity.getLockCount())
                .status(groupBuyTeamEntity.getStatus())
                .build();
    }
}
```

5 SCæ¥æºæ¸ é“é»‘åå•åŠ¨æ€é…ç½®

```java
@Slf4j
@Service
public class DCCService 

@DCCValue("scBlacklist:s02c02")  // é»˜è®¤é»‘åå•æ¸ é“
private String scBlacklist;

public Boolean isSCBlackIntercept(String source, String channel) {
    List<String> list = Arrays.asList(scBlacklist.split(Constants.SPLIT));
    return list.contains(source + channel);
}

// Httpè¯·æ±‚key=scBlacklist&value=s02c02;s03c03

// => Redis (scBlacklist) => scBlacklist,s02c02;s03c03 
```



---

### **ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡**

â±ï¸25/4/9 15:32

æ‹¼å›¢ç»„é˜Ÿäº¤æ˜“ç»“ç®—å®Œç»“åï¼Œå®ç°ä¸€ä¸ªå›è°ƒé€šçŸ¥çš„ä»»åŠ¡å¤„ç†ã€‚å‘ŠçŸ¥å¦å¤–çš„å¾®æœåŠ¡ç³»ç»Ÿå¯ä»¥è¿›è¡Œåç»­çš„æµç¨‹äº†ã€‚

RPCã€MQï¼Œè¿™ä¸€ç±»çš„éƒ½æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå…¬ç”¨çš„æ³¨å†Œä¸­å¿ƒï¼Œå®ƒçš„æŠ€æœ¯æ¶æ„æ¯”è¾ƒé€‚åˆäºå…¬å¸å†…éƒ¨çš„ç»Ÿä¸€ç³»ç»Ÿä½¿ç”¨ã€‚å¦‚æœæ˜¯æœ‰å’Œå¤–éƒ¨å…¶ä»–ç³»ç»Ÿçš„å¯¹æ¥ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ HTTP è¿™æ ·ç»Ÿä¸€æ ‡å‡†åè®®çš„æ¥å£è¿›è¡Œä½¿ç”¨ã€‚

æ³¨æ„ï¼šå¾®ä¿¡æ”¯ä»˜ï¼Œæ”¯ä»˜å®æ”¯ä»˜ï¼Œä¹Ÿæ˜¯åœ¨å®Œæˆæ”¯ä»˜åï¼Œåšçš„è¿™æ ·çš„å›è°ƒå¤„ç†ã€‚

![image-20250409153440408](C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250409153440408.png)

ğŸ’¡**æµç¨‹é€»è¾‘ 1ï¼šé”å•**

```java
// 1. æ£€æŸ¥é”å•è¯·æ±‚ä¿¡æ¯ - è¯·æ±‚å‚æ•°æ˜¯å¦ä¸ºNull or ç©ºä¸²
// 2. æ£€æŸ¥outTradeNoæ˜¯å¦é‡å¤é”å• - æ£€æŸ¥æ£€æŸ¥outTradeNoæ˜¯å¦é‡å¤é”å•æ˜¯å¦å­˜åœ¨
// 3. æ‹¼å›¢æ˜¯å¦èƒ½å¤ŸåŠ å…¥ - åˆ¤æ–­æ‹¼å›¢å½“å‰äººæ•°å°äºç›®æ ‡äººæ•°
// 4. è¥é”€ä¼˜æƒ è¯•ç®—
// 	  4.1. RootNode => SwitchRoot => MarketNode => TagNode => EndNode
//                                              => ErrorNode
// 		4.1.1 RootNodeæ£€æŸ¥ä¿¡æ¯
// 		4.1.2 SwitchRoot é™çº§å’Œé™æµ
// 		4.1.3 MarketNode 1:å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯+æ´»åŠ¨ä¿¡æ¯ 2:è¿›è¡ŒæŠ˜æ‰£éªŒç®—(æ ¹æ®Mapæ‹¿åˆ°å¯¹åº”çš„æŠ˜æ‰£å¯¹è±¡ - æ¯ä¸ªæŠ˜æ‰£å¯¹è±¡å®ç°åŒä¸€æ¥å£)
// 		4.1.4-1 TagNodeï¼šæ ¹æ®bitsetï¼Œæ£€æŸ¥ç”¨æˆ·Idæ˜¯å¦æœ‰èµ„æ ¼å‚ä¸orå¯è§è¯¥æŠ˜æ‰£æ´»åŠ¨
//		4.1.4-2 ErrorNodeï¼šæ— æŠ˜æ‰£æ´»åŠ¨è¿”å›
// 		4.1.5 EndNode ç»„è£…è¯•ç®—ç»“æœ
// 5. æ ¹æ®è¯•ç®—ç»“æœåˆ¤æ–­æ˜¯å¦å¯è§å’Œå¯å‚ä¸
// 6. è¿›è¡Œé”å•
//	  6.1. äº¤æ˜“è§„åˆ™æ£€æŸ¥ - æ ¡éªŒæ´»åŠ¨çŠ¶æ€+æ´»åŠ¨æ—¶é—´ && æ ¡éªŒå‚ä¸æ¬¡æ•°  -è´£ä»»é“¾
//      LinkArmory(BusinessLinkedList:ActivityUsabilityRuleFilter+UserTakeLimitRuleFilter)
//		6.1.1 ActivityUsabilityRuleFilter: æ£€æŸ¥æ´»åŠ¨çŠ¶æ€å’Œæ—¶é—´
//		6.1.2 UserTakeLimitRuleFilter:     æ£€æŸ¥ç”¨æˆ·å‚ä¸æ¬¡æ•°
//    6.2. åˆ¤æ–­æ˜¯å¦æœ‰å›¢ - ç”Ÿæˆæ‹¼å›¢è®¢å• or åŠ å…¥åˆ«äººçš„è®¢å•  => æ’å…¥orä¿®æ”¹è®°å½• GroupBuyOrder
//    6.3. ç”Ÿæˆè®¢å•æ˜ç»†  => æ’å…¥è®°å½•åˆ°GroupBuyOrderList
```

**ğŸ’¡æµç¨‹é€»è¾‘ 2ï¼šç»“ç®—**

```java
// 1. æ£€æŸ¥æ‹¼å›¢ä¿¡æ¯ - ç»“ç®—è§„åˆ™
// 	  1.1 æ£€æŸ¥ æ¸ é“åˆæ³•æ€§=>å¤–éƒ¨è®¢å•åˆæ³•æ€§=>æ‹¼å›¢æ—¶é—´åˆæ³•æ€§=>åŒ…è£…æ£€æŸ¥ç»“æœ
//    		1.1.1 SCRuleFilter: æ£€æŸ¥sourceå’Œchannelæ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œ@DCCValue("scBlacklist:s02c02"), å¯åŠ¨æ€é…ç½®
//   		1.1.2 OutTradeNoRuleFilterï¼šæ£€æŸ¥OutTradeNoæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦GroupBuyOrderListå­˜åœ¨åˆå§‹é”å•çš„æ‹¼å›¢è®¢å• 
//			(è¿™é‡Œï¼Œå¤–éƒ¨è¿›è¡Œäº†æ”¯ä»˜ï¼Œä½†æ˜¯ç³»ç»Ÿè¿˜æ²¡ä¿®æ”¹ç»“ç®—çŠ¶æ€å‘¢)
// 			1.1.3 SettableRuleFilterï¼šæ£€æŸ¥è®¢å•äº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…
// 			1.1.4 EndRuleFilterï¼šåŒ…è£…ç»“æœ
// 2. è¿›è¡Œæ‹¼å›¢ç»“ç®—
// 	  2.1 æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»† => GroupBuyOrderListå¯¹åº”ç”¨æˆ·çš„å®ŒæˆçŠ¶æ€
//    2.2 æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡ => GroupBuyOrderå¯¹åº”çš„ç”¨æˆ·å®Œæˆæ”¯ä»˜æ•°é‡
//    2.3 æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€ => æœ€åä¸€ä¸ªäººæ”¯ä»˜å®Œæˆè§¦å‘ => GroupBuyOrderæ‹¼å›¢ä¿¡æ¯çŠ¶æ€ => å†™å…¥å›è°ƒä»»åŠ¡è®°å½•(åŒ…è£…TeamId+æ‰€æœ‰çš„å¤–éƒ¨è®¢å•ID)
// 3. ç»„é˜Ÿå›è°ƒå¤„ç† - è¿™é‡Œæ˜¾ç¤ºçš„æ‰§è¡Œï¼Œä½¿å¾—å®æ—¶æ€§æ¯”è¾ƒå¥½ï¼Œåªæœ‰æœ€åä¸€ä¸ªäººå®Œæˆæ‰ä¼šæ‰§è¡ŒæˆåŠŸï¼Œä¸è¿‡æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œå…œåº•
// 	  3.1 å‘é€Httpè¿œç¨‹è°ƒç”¨ï¼Œå°†(TeamId+æ‰€æœ‰çš„å¤–éƒ¨è®¢å•ID)å‘é€ç»™ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œé€šçŸ¥å‘è´§orå…¶ä»–
//    3.2 å®šæ—¶ä»»åŠ¡ï¼šæŸ¥è¯¢æ‰€æœ‰åˆå§‹çŠ¶æ€å’Œé‡è¯•çŠ¶æ€çš„ é€šçŸ¥ä»»åŠ¡
```

ğŸ·ï¸**æœ¬ç« èŠ‚å®Œæˆ 3 è§¦å‘å›è°ƒéƒ¨åˆ†**

```java
// æŒ‡å®šè§¦å‘å›è°ƒé€šçŸ¥ä»»åŠ¡  - å®æ—¶æ€§
@Override 
public Map<String, Integer> execSettlementNotifyJob(String teamId) throws Exception {
    log.info("æ‹¼å›¢äº¤æ˜“-æ‰§è¡Œç»“ç®—é€šçŸ¥å›è°ƒï¼ŒæŒ‡å®š teamId:{}", teamId);

    List<NotifyTaskEntity> notifyTaskEntityList = repository.queryUnExecutedNotifyTaskList(teamId);
    return execSettlementNotifyJob(notifyTaskEntityList);
}

// è¾…åŠ©å®šæ—¶æ‰«æï¼Œè¿›è¡Œé€šçŸ¥ - å…œåº•
@Override
public Map<String, Integer> execSettlementNotifyJob() throws Exception {
    log.info("æ‹¼å›¢äº¤æ˜“-æ‰§è¡Œç»“ç®—é€šçŸ¥ä»»åŠ¡");

    // æŸ¥è¯¢æœªæ‰§è¡Œä»»åŠ¡
    List<NotifyTaskEntity> notifyTaskEntities = repository.queryUnExecutedNotifyTaskList();

    return execSettlementNotifyJob(notifyTaskEntities);
}

// å…¬ç”¨é€šçŸ¥å‡½æ•°
private Map<String, Integer> execSettlementNotifyJob(List<NotifyTaskEntity> notifyTaskEntities) throws Exception {
    int successCount = 0, errorCount = 0, retryCount = 0;
    for (NotifyTaskEntity notifyTask : notifyTaskEntities) {
        // å›è°ƒå¤„ç†
        String response = port.groupBuyNotify(notifyTask);

        if (NotifyTaskHTTPEnumVO.SUCCESS.getCode().equals(response)) {
            int i = repository.updateNotifyTaskStatusSuccess(notifyTask.getTeamId());
            if (1 == i) {
                successCount += 1;
            }
        } else if (NotifyTaskHTTPEnumVO.ERROR.getCode().equals(response)) {
            int i = repository.updateNotifyTaskStatusError(notifyTask.getTeamId());
            if (1 == i) {
                errorCount += 1;
            }
        } else {
            int i = repository.updateNotifyTaskStatusRetry(notifyTask.getTeamId());
            if (1 == i) {
                retryCount += 1;
            }
        }
    }

    Map<String, Integer> resultMap = new HashMap<>();
    resultMap.put("waitCount", notifyTaskEntities.size());
    resultMap.put("successCount", successCount);
    resultMap.put("errorCount", errorCount);
    resultMap.put("retryCount", retryCount);

    return resultMap;
}

// è¿œç¨‹è°ƒç”¨
@Override
public String groupBuyNotify(NotifyTaskEntity notifyTask) throws Exception {
    RLock lock = redisService.getLock(notifyTask.lockKey());
    try {
        // æ‹¼å›¢æœåŠ¡å™¨éƒ¨ç½²åœ¨å¤šå°åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œå¤šä»»åŠ¡æ‰§è¡Œï¼Œé¿å…ä»»åŠ¡è¢«å¤šæ¬¡æ‰§è¡Œï¼Œé”çš„ç²’åº¦ xxx:teamId
        if (lock.tryLock(3, 0, TimeUnit.SECONDS)) {
            try {
                if (StringUtils.isBlank(notifyTask.getNotifyUrl()) || "æš‚æ— ".equals(notifyTask.getNotifyUrl())) {
                    return NotifyTaskHTTPEnumVO.SUCCESS.getCode();
                }
                return â­groupBuyNotifyService.groupBuyNotify(notifyTask.getNotifyUrl(), notifyTask.getParameterJson());â­ // è¿™é‡Œè¿›è¡Œè¿œç¨‹è°ƒç”¨
            } finally {
                if (lock.isLocked() && lock.isHeldByCurrentThread())
                    lock.unlock();
            }
        }
        return NotifyTaskHTTPEnumVO.NULL.getCode();
    }catch (Exception e) {
        Thread.currentThread().interrupt();
        return NotifyTaskHTTPEnumVO.NULL.getCode();
    }
}

// OKHttpå‘é€è¯·æ±‚
public String groupBuyNotify(String apiUrl, String notifyRequestDTOJSON) {
    try {
        // 1. æ„å»ºå‚æ•°
        MediaType mediaType = MediaType.parse("application/json");
        RequestBody body = RequestBody.create(mediaType, notifyRequestDTOJSON);
        Request request = new Request.Builder()
            .url(apiUrl)
            .post(body)
            .addHeader("content-type", "application/json")
            .build();

        // 2. è°ƒç”¨æ¥å£
        Response response = okHttpClient.newCall(request).execute();

        // 3. è¿”å›ç»“æœ
        return response.body().string();
    } catch (IOException e) {
        log.info("æ‹¼å›¢å›è°ƒ HTTP æ¥å£æœåŠ¡å¼‚å¸¸ {}", apiUrl, e);
        throw new AppException(ResponseCode.HTTP_EXCEPTION);
    }
}
```



---

### ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250409202305147.png" alt="image-20250409202305147" style="zoom:60%;" />

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250409202122844.png" alt="image-20250409202122844" style="zoom:50%;" />



- ç´«è‰²åœˆï¼šæ‹¼å›¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼›
- ç°è‰²åœˆï¼šå•†å“ä¿¡æ¯ï¼›
- çº¢è‰²åœˆï¼šå‚ä¸æ‹¼å›¢ï¼ŒéšæœºæŒ‘é€‰å‡ ä¸ªå›¢ï¼›
- ç»¿è‰²åœˆï¼šå‚ä¸æ‹¼å›¢ï¼›å•ç‹¬å¼€å§‹ä¸€ä¸ªæ–°çš„å›¢ï¼Œè¿˜æ˜¯å‚ä¸å…¶ä»–äººçš„å›¢

- é»„è‰²åœˆï¼šæ‹¼å›¢ç»“ç®—ã€‚

**ResponseDTO**

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class GoodsMarketResponseDTO {

    private Goods goods;
    private List<Team> teamList;
    private TeamStatistic teamStatistic;

    /**
     * å•†å“ä¿¡æ¯
     */
    @Data
    @Builder
    @AllArgsConstructor
    @NoArgsConstructor
    public static class Goods {
        // å•†å“ID
        private String goodsId;
        // åŸå§‹ä»·æ ¼
        private BigDecimal originalPrice;
        // æŠ˜æ‰£é‡‘é¢
        private BigDecimal deductionPrice;
        // æ”¯ä»˜ä»·æ ¼
        private BigDecimal payPrice;
    }

    /**
     * ç»„é˜Ÿä¿¡æ¯
     */
    @Data
    @Builder
    @AllArgsConstructor
    @NoArgsConstructor
    public static class Team {
        // ç”¨æˆ·ID
        private String userId;
        // æ‹¼å•ç»„é˜ŸID
        private String teamId;
        // æ´»åŠ¨ID
        private Long activityId;
        // ç›®æ ‡æ•°é‡
        private Integer targetCount;
        // å®Œæˆæ•°é‡
        private Integer completeCount;
        // é”å•æ•°é‡
        private Integer lockCount;
        // æ‹¼å›¢å¼€å§‹æ—¶é—´ - å‚ä¸æ‹¼å›¢æ—¶é—´
        private Date validStartTime;
        // æ‹¼å›¢ç»“æŸæ—¶é—´ - æ‹¼å›¢æœ‰æ•ˆæ—¶é•¿
        private Date validEndTime;
        // å€’è®¡æ—¶(å­—ç¬¦ä¸²) validEndTime - validStartTime
        private String validTimeCountdown;
        /** å¤–éƒ¨äº¤æ˜“å•å·-ç¡®ä¿å¤–éƒ¨è°ƒç”¨å”¯ä¸€å¹‚ç­‰ */
        private String outTradeNo;

        public static String differenceDateTime2Str(Date validStartTime, Date validEndTime) {
            if (validStartTime == null || validEndTime == null) {
                return "æ— æ•ˆçš„æ—¶é—´";
            }

            long diffInMilliseconds = validEndTime.getTime() - validStartTime.getTime();

            if (diffInMilliseconds < 0) {
                return "å·²ç»“æŸ";
            }

            long seconds = TimeUnit.MILLISECONDS.toSeconds(diffInMilliseconds) % 60;
            long minutes = TimeUnit.MILLISECONDS.toMinutes(diffInMilliseconds) % 60;
            long hours = TimeUnit.MILLISECONDS.toHours(diffInMilliseconds) % 24;
            long days = TimeUnit.MILLISECONDS.toDays(diffInMilliseconds);

            return String.format("%02d:%02d:%02d", hours, minutes, seconds);
        }

    }


    /**
     * ç»„é˜Ÿç»Ÿè®¡
     */
    @Data
    @Builder
    @AllArgsConstructor
    @NoArgsConstructor
    public static class TeamStatistic {
        // å¼€å›¢é˜Ÿä¼æ•°é‡
        private Integer allTeamCount;
        // æˆå›¢é˜Ÿä¼æ•°é‡
        private Integer allTeamCompleteCount;
        // å‚å›¢äººæ•°æ€»é‡ - ä¸€ä¸ªå•†å“çš„æ€»å‚å›¢äººæ•°
        private Integer allTeamUserCount;
    }

}
```

```java
// å¢åˆ æ”¹æŸ¥
// æ³¨æ„ï¼šTeamçš„æŸ¥è¯¢
// 1. å…ˆæŸ¥è‡ªå·±çš„æ‹¼å›¢
// 2. æŸ¥å…¶ä»–äººçš„æ‹¼å›¢ã€‚å¯¹åº”æ´»åŠ¨ï¼Œéå½“å‰ç”¨æˆ·ï¼ŒçŠ¶æ€ä¸ºå¯åŠ å…¥æ‹¼å›¢ï¼Œæ—¶é—´æœ‰æ•ˆï¼Œé˜Ÿä¼in(å¯¹åº”æ´»åŠ¨ï¼Œä¸”é”å•äººæ•°å°äºç›®æ ‡äººæ•°)

@Override
public List<UserGroupBuyOrderDetailEntity> queryInProgressUserGroupBuyOrderDetailListByRandom(Long activityId, String userId, Integer randomCount) {
    // 1. æ ¹æ®ç”¨æˆ·IDã€æ´»åŠ¨IDã€æŸ¥è¯¢éå½“å‰ç”¨æˆ·å‚ä¸çš„æ‹¼å›¢é˜Ÿä¼
    GroupBuyOrderList buyOrderListReq = GroupBuyOrderList.builder()
        .activityId(activityId)
        .userId(userId)
        .build();
    buyOrderListReq.setCount(randomCount * 2); // æŸ¥è¯¢ä¸¤å€çš„é‡ï¼Œå†éšæœºå–ä¸€åŠ

    // 1. ==ActivityId; 2. !=userId 3; status == 0 or 1; 4. endTime > now(); 5. teamId in (select teamId from group_buy_order where status = 0 and activity = #{activity})
    List<GroupBuyOrderList> groupBuyOrderLists = groupBuyOrderListDao.queryInProgressUserGroupBuyOrderDetailListByRandom(buyOrderListReq);
    if (groupBuyOrderLists == null || groupBuyOrderLists.isEmpty())
        return null;

    // éšæœºé€‰ randomCount æ¡
    if (groupBuyOrderLists.size() > randomCount) {
        Collections.shuffle(groupBuyOrderLists);
        groupBuyOrderLists = groupBuyOrderLists.subList(0, randomCount);
    }

    // 2. è¿‡æ»¤é˜Ÿä¼è·å– TeamId
    Set<String> teamIds = groupBuyOrderLists.stream().map(GroupBuyOrderList::getTeamId)
        .filter(teamId -> teamId != null && !teamId.isEmpty())
        .collect(Collectors.toSet());


    // 3. æŸ¥è¯¢é˜Ÿä¼æ˜ç»†ï¼Œç»„è£…Mapç»“æ„
    List<GroupBuyOrder> groupBuyOrders = groupBuyOrderDao.queryGroupBuyProgressByTeamIds(teamIds);
    if (groupBuyOrders == null || groupBuyOrders.isEmpty()) return null;

    Map<String, GroupBuyOrder> groupBuyOrderMap = groupBuyOrders.stream()
        .collect(Collectors.toMap(GroupBuyOrder::getTeamId, order -> order));

    // 4. è½¬æ¢æ•°æ®
    ArrayList<UserGroupBuyOrderDetailEntity> userGroupBuyOrderDetailEntities = new ArrayList<>();
 	// ... æ ¹æ® groupBuyOrders å’Œ groupBuyOrderListsç»„è£…ç»“æœ

    return userGroupBuyOrderDetailEntities;
}
```

```java
// é”å• æ¥å£
â¬‡ï¸
// outTradeNo - è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ç”Ÿæˆ
â¬‡ï¸
// ç»“ç®— æ¥å£
```

<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250410001830020.png" alt="image-20250410001830020" style="zoom:50%;" />



---



